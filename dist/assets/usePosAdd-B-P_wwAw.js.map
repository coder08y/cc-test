{"version":3,"file":"usePosAdd-B-P_wwAw.js","sources":["../../src/hooks/position/usePosAdd.ts"],"sourcesContent":["import useGlobalStore from '@/store/common/global'\nimport { MsafeTransactionSubType, PrePosAddRes } from '@/types'\nimport { useSdk } from '@cetus/sdk-factory'\nimport { Token } from '@cetus/types'\nimport { bnToAmount, d } from '@cetus/utils'\nimport { ClmmPoolUtil } from '@cetusprotocol/common-sdk'\nimport BN from 'bn.js'\n\ntype GetAddTsPayload = {\n  poolAddress: string\n  coinTypeA: string\n  coinTypeB: string\n  amountA: string\n  amountB: string\n  fixAmountA: boolean\n  lowerTick: number\n  upperTick: number\n  currentSqrtPrice: string\n  posType: 'clmm' | 'farms'\n  rewarderCoinTypes: any\n  isAutoClaim: boolean\n  posIndex?: string\n  posId?: string\n  farmsPoolId?: string\n}\n\nexport default function usePosAdd() {\n  const clmmSdk = useSdk('clmm')\n  const farmsSdk = useSdk('farms')\n\n  const { slippage } = useGlobalStore()\n  /**\n   * 与计算\n   * @param\n   * isTokenA: 输入的token === tokenA 为true\n   * roundUp都传true就行\n   * @returns\n   */\n  const preAdd = (params: {\n    amount: string | BN\n    tokenA: Token\n    tokenB: Token\n    isTokenA: boolean\n    lowerTick: number\n    upperTick: number\n    curSqrtPrice: string\n    isReverse: boolean\n    roundUp: boolean\n  }): PrePosAddRes => {\n    console.log('🚀 ~ usePosAdd ~ params:', params)\n    const { amount, tokenA, tokenB, isTokenA, lowerTick, upperTick, curSqrtPrice, isReverse, roundUp } = params\n\n    const coinAmount = new BN(amount)\n    console.log('🚀 ~ usePosAdd ~ coinAmount:', slippage, curSqrtPrice, coinAmount.toString())\n    const { coin_amount_a, coin_amount_b, coin_amount_limit_a, coin_amount_limit_b, liquidity_amount } =\n      ClmmPoolUtil.estLiquidityAndCoinAmountFromOneAmounts(\n        lowerTick,\n        upperTick,\n        coinAmount,\n        isTokenA,\n        roundUp,\n        d(slippage).toNumber(),\n        new BN(curSqrtPrice)\n      )\n    console.log('🚀 ~ usePosAdd ~ coinAmountA:', coin_amount_a.toString())\n    console.log('🚀 ~ usePosAdd ~ coinAmountB:', coin_amount_b.toString())\n\n    const decimalsA = tokenA.decimals\n    const decimalsB = tokenB.decimals\n\n    return {\n      coinAmountAOrigin: coin_amount_a.toString(),\n      coinAmountBOrigin: coin_amount_b.toString(),\n      displayCoinAmountA: !isReverse ? bnToAmount(coin_amount_a.toString(), decimalsA) : bnToAmount(coin_amount_b.toString(), decimalsB),\n      displayCoinAmountB: !isReverse ? bnToAmount(coin_amount_b.toString(), decimalsB) : bnToAmount(coin_amount_a.toString(), decimalsA),\n      coinAmountA: bnToAmount(coin_amount_a.toString(), decimalsA),\n      coinAmountB: bnToAmount(coin_amount_b.toString(), decimalsB),\n      tokenMaxA: coin_amount_limit_a.toString(),\n      tokenMaxB: coin_amount_limit_b.toString(),\n      liquidityAmount: liquidity_amount.toString()\n    }\n  }\n  const getClmmCreateAddData = async (params: GetAddTsPayload) => {\n    console.log('🚀🚀🚀 ~ usePosAdd.ts:83 ~ getClmmCreateAddData ~ getClmmCreateAddData:', getClmmCreateAddData)\n    const {\n      poolAddress,\n      coinTypeA,\n      coinTypeB,\n      fixAmountA,\n      amountA,\n      amountB,\n      lowerTick,\n      upperTick,\n      currentSqrtPrice,\n      posType,\n      rewarderCoinTypes,\n      posIndex,\n      posId,\n      farmsPoolId,\n      isAutoClaim\n    } = params\n\n    const createAddParams = {\n      coin_type_a: coinTypeA,\n      coin_type_b: coinTypeB,\n      amount_a: amountA,\n      amount_b: amountB,\n      pool_id: poolAddress,\n      fix_amount_a: fixAmountA,\n      slippage: d(slippage).toNumber(),\n      is_open: !posIndex,\n      tick_lower: lowerTick,\n      tick_upper: upperTick,\n      collect_fee: isAutoClaim ? (!posIndex ? false : true) : false,\n      rewarder_coin_types: isAutoClaim ? rewarderCoinTypes : [],\n      pos_id: posId || ''\n    }\n\n    const gasEstimateArg = {\n      slippage: d(slippage).toNumber(),\n      cur_sqrt_price: new BN(currentSqrtPrice)\n    }\n\n    const tx = await clmmSdk!.Position.createAddLiquidityFixTokenPayload(createAddParams, gasEstimateArg)\n    console.log('🚀🚀🚀 ~ usePosAdd.ts:123 ~ getClmmCreateAddData ~ tx:', tx)\n\n    const msafeParams = {\n      action: !posIndex ? MsafeTransactionSubType.OpenAndAddLiquidity : MsafeTransactionSubType.IncreaseLiquidity,\n      txbParams: {\n        parameter: createAddParams,\n        gasEstimateArg\n      }\n    }\n    console.log('🚀 ~ getClmmCreateAddData ~ msafeParams:', msafeParams, tx)\n\n    return {\n      tx,\n      msafeParams\n    }\n  }\n\n  const getFarmsCreateAddData = async (params: GetAddTsPayload) => {\n    const {\n      poolAddress,\n      coinTypeA,\n      coinTypeB,\n      fixAmountA,\n      amountA,\n      amountB,\n      lowerTick,\n      upperTick,\n      currentSqrtPrice,\n      posType,\n      rewarderCoinTypes,\n      posIndex,\n      posId,\n      farmsPoolId,\n      isAutoClaim\n    } = params\n\n    let tx: any\n    let msafeParams: any\n    if (posId) {\n      const parameter = {\n        pool_id: farmsPoolId || '',\n        coin_type_a: coinTypeA,\n        coin_type_b: coinTypeB,\n        position_nft_id: posId,\n        clmm_pool_id: poolAddress,\n        amount_a: amountA,\n        amount_b: amountB,\n        collect_fee: isAutoClaim,\n        collect_rewarder: false,\n        fix_amount_a: fixAmountA,\n        clmm_rewarder_types: isAutoClaim ? rewarderCoinTypes : []\n      }\n\n      console.log('🚀 ~ getFarmsCreateAddData ~ parameter:', parameter)\n      tx = await farmsSdk!.Farms.addLiquidityFixCoinPayload(parameter)\n\n      msafeParams = {\n        action: MsafeTransactionSubType.FarmingIncreaseLiquidity,\n        txbParams: parameter\n      }\n    } else {\n      const parameter = {\n        pool_id: farmsPoolId || '',\n        coin_type_a: coinTypeA,\n        coin_type_b: coinTypeB,\n        clmm_pool_id: poolAddress,\n        amount_a: amountA,\n        amount_b: amountB,\n        fix_amount_a: fixAmountA,\n        tick_lower: lowerTick,\n        tick_upper: upperTick\n      }\n      console.log('🚀 ~ getFarmsCreateAddData ~ parameter else:', parameter)\n\n      tx = await farmsSdk!.Farms.openPositionAddLiquidityStakePayload(parameter)\n      console.log('🚀 ~ getFarmsCreateAddData ~ tx:', tx)\n\n      msafeParams = {\n        action: MsafeTransactionSubType.FarmingOpenAndAddLiquidity,\n        txbParams: parameter\n      }\n    }\n\n    console.log('🚀 ~ getFarmsCreateAddData ~ msafeParams:', msafeParams, tx)\n\n    return {\n      tx,\n      msafeParams\n    }\n  }\n\n  // 获取创建添加，追加tx(clmm, farms)\n  const getAddTsPayload = (params: GetAddTsPayload) => {\n    console.log('🚀 ~ getAddTsPayload ~ params:', params)\n    const { posType } = params\n\n    if (posType === 'clmm') {\n      return getClmmCreateAddData(params)\n    } else {\n      return getFarmsCreateAddData(params)\n    }\n  }\n\n  return {\n    preAdd,\n    getAddTsPayload,\n    getClmmCreateAddData,\n    getFarmsCreateAddData\n  }\n}\n"],"names":["usePosAdd","clmmSdk","useSdk","farmsSdk","slippage","useGlobalStore","preAdd","params","amount","tokenA","tokenB","isTokenA","lowerTick","upperTick","curSqrtPrice","isReverse","roundUp","coinAmount","BN","coin_amount_a","coin_amount_b","coin_amount_limit_a","coin_amount_limit_b","liquidity_amount","ClmmPoolUtil","d","decimalsA","decimalsB","bnToAmount","getClmmCreateAddData","poolAddress","coinTypeA","coinTypeB","fixAmountA","amountA","amountB","currentSqrtPrice","posType","rewarderCoinTypes","posIndex","posId","farmsPoolId","isAutoClaim","createAddParams","gasEstimateArg","tx","msafeParams","MsafeTransactionSubType","getFarmsCreateAddData","parameter"],"mappings":"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"}