{"version":3,"file":"useCurrentPos-qZJLM1cy.js","sources":["../../src/hooks/position/useCurrentPos.ts"],"sourcesContent":["import { FrozenPools } from '@/constant/pool'\nimport usePositionStore from '@/store/position'\nimport usePositionDetailStore from '@/store/position/detail'\nimport { PosBaseInfo } from '@/types'\nimport { useSdk } from '@cetus/sdk-factory'\nimport useGetPosInfoList from './useGetPosInfoList'\nimport useGetPositionVesting from './useGetPosVesting'\nimport usePositionList from './usePositionList'\nimport useWrapPosData from './useWrapPosData'\n\nexport default function useCurrentPos() {\n  const clmmSdk = useSdk('clmm')\n\n  const { posBaseList, setCurrentPosBaseInfo, setCurrentPosBaseInfoLoading } = usePositionStore()\n  const { setCurPosHistoryList, setIsPosHistoryLoading } = usePositionDetailStore()\n  const { buildPosBaseInfo } = useWrapPosData()\n  const { getPosRelatedData } = usePositionList()\n  const { getVestingList } = useGetPositionVesting()\n  const { getPositionInfoList } = useGetPosInfoList()\n\n  const getCurrentPosBaseInfo = async (account: string, id: string, isForceRefresh: boolean = false) => {\n    console.log('ðŸš€ ~ getCurrentPosBaseInfo ~ id:', id)\n    setCurrentPosBaseInfoLoading(true)\n\n    const posBaseInfoFrom = posBaseList.find((item: PosBaseInfo) => item.id === id)\n    let posInfo: PosBaseInfo | null\n    if (posBaseInfoFrom && !isForceRefresh) {\n      posInfo = posBaseInfoFrom\n    } else {\n      posInfo = await getCurrentPosByPosId(account, id)\n    }\n\n    console.log('getCurrentPosBaseInfo ~ posInfo:', posBaseList, posInfo)\n    if (posInfo) {\n      posInfo['isFrozen'] = FrozenPools.includes(posInfo!.clmmPool)\n    }\n\n    setCurrentPosBaseInfo(posInfo)\n\n    if (posInfo) {\n      getPosRelatedData([posInfo])\n    }\n  }\n\n  const getCurrentPosByPosId = async (account: string, id: string) => {\n    const ownerRes = await clmmSdk!.FullClient.getOwnedObjectsByPage(account, {\n      options: { showType: true, showContent: true, showOwner: true },\n      filter: {\n        ObjectId: id\n      }\n    })\n\n    if (ownerRes && ownerRes.data && ownerRes.data.length > 0) {\n      let posRes = await buildPosBaseInfo(ownerRes.data[0])\n      if (posRes?.posId) {\n        const vestingList = await getVestingList([posRes])\n        console.log('ðŸš€ ~ getCurrentPosByPosId ~ vestingList:', vestingList)\n        if (vestingList?.length > 0) {\n          const list = await getPositionInfoList([posRes], vestingList)\n          console.log('ðŸš€ ~ getCurrentPosByPosId ~ list:', list)\n\n          if (list?.length > 0) {\n            posRes = list[0]\n          }\n        }\n\n        // const list = await getPositionInfoList([posRes], [], true)\n        // console.log('ðŸš€ ~ getCurrentPosByPosId ~ list:', list)\n\n        // if (list?.length > 0) {\n        //   posRes = list[0]\n        // }\n      }\n\n      console.log('ðŸš€ ~ getCurrentPosByPosId ~ posRes:', posRes)\n      return posRes\n    }\n    return null\n  }\n\n  const fetchPositionHistory = async (posId: string, originPosId: string) => {\n    const rpcList = ['https://mainnet.suiet.app:443', 'https://rpc-mainnet.suiscan.xyz:443']\n    for (const rpc of rpcList) {\n      try {\n        const response = await clmmSdk!.Position.getPositionTransactionList({\n          pos_id: posId,\n          full_rpc_url: rpc,\n          origin_pos_id: originPosId,\n          order: 'descending'\n        })\n        console.log('ðŸš€ ~ getCurrentPosHistory ~ response?.data:', response?.data, rpc)\n        if (response?.data?.length > 0) {\n          return response.data\n        }\n      } catch (error) {\n        console.error(`Error fetching data from ${rpc}:`, error)\n      }\n    }\n    return []\n  }\n\n  const getCurrentPosHistory = async (id: string, posId: string) => {\n    // posIdä¸ºclmm id ä¹Ÿå°±æ˜¯åŽŸå§‹idï¼ˆoriginPosIdï¼‰\n    console.log('ðŸš€ ~ getCurrentPosHistory ~ posId:', id, posId)\n    setIsPosHistoryLoading(true)\n\n    const clmmHistory = await fetchPositionHistory(id, posId)\n    const otherHistory = id.toLowerCase() !== posId.toLowerCase() ? await fetchPositionHistory(posId, posId) : []\n\n    console.log('ðŸš€ ~ getCurrentPosHistory ~ clmmHistory:', clmmHistory, otherHistory, [...clmmHistory, ...otherHistory])\n    const combinedHistory = [...clmmHistory, ...otherHistory]\n    const sortedHistory = combinedHistory.sort((a: any, b: any) => b?.timestampMs - a?.timestampMs)\n\n    setCurPosHistoryList(sortedHistory)\n    setIsPosHistoryLoading(false)\n\n    console.log('ðŸš€ ~ getCurrentPosHistory ~ result:', sortedHistory)\n  }\n\n  const getPoolLiquiditySnapshot = async (pos: PosBaseInfo) => {\n    const poolSnaps = await clmmSdk!.Pool.getPoolLiquiditySnapshot(pos.clmmPool)\n    console.log('getPoolLiquiditySnapshot poolSnaps: ', poolSnaps)\n\n    const posSnap = await clmmSdk!.Pool.getPositionSnapshot(poolSnaps.snapshots.id, [pos.posId])\n    console.log('getPoolLiquiditySnapshot posSnap: ', posSnap)\n  }\n  return {\n    getCurrentPosBaseInfo,\n    getCurrentPosHistory,\n    getCurrentPosByPosId,\n    getPoolLiquiditySnapshot\n  }\n}\n"],"names":["useCurrentPos","clmmSdk","useSdk","posBaseList","setCurrentPosBaseInfo","setCurrentPosBaseInfoLoading","usePositionStore","setCurPosHistoryList","setIsPosHistoryLoading","usePositionDetailStore","buildPosBaseInfo","useWrapPosData","getPosRelatedData","usePositionList","getVestingList","useGetPositionVesting","getPositionInfoList","useGetPosInfoList","getCurrentPosBaseInfo","account","id","isForceRefresh","posBaseInfoFrom","item","posInfo","getCurrentPosByPosId","FrozenPools","ownerRes","posRes","vestingList","list","fetchPositionHistory","posId","originPosId","rpcList","rpc","response","_a","error","clmmHistory","otherHistory","sortedHistory","b","pos","poolSnaps","posSnap"],"mappings":"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"}